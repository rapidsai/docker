name: Test notebooks

on:
  workflow_call:
    inputs:
      BUILD_TYPE:
        required: true
        type: string
      ARCH:
        required: true
        type: string
      GPU:
        required: true
        type: string
      DRIVER:
        required: true
        type: string
      CUDA_VER:
        required: true
        type: string
      LINUX_VER:
        required: true
        type: string
      PYTHON_VER:
        required: true
        type: string
      RAPIDS_VER:
        required: true
        type: string
      # DASK_SQL_VER:
      #   required: true
      #   type: string
      # BASE_TAG:
      #   required: true
      #   type: string
      NOTEBOOKS_TAG:
        required: true
        type: string

jobs:
  docker-test:
    runs-on: "linux-${{ inputs.ARCH }}-gpu-${{ inputs.GPU }}-${{ inputs.DRIVER }}-1"
    container:
      image: ${{ inputs.NOTEBOOKS_TAG }}
      env:
        NVIDIA_VISIBLE_DEVICES: ${{ env.NVIDIA_VISIBLE_DEVICES }}
        RAPIDS_BUILD_TYPE: ${{ inputs.build_type }}
        RAPIDS_GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Install gha-tools
        run: |
          mkdir -p /tmp/gha-tools
          curl -s -L 'https://github.com/rapidsai/gha-tools/releases/latest/download/tools.tar.gz' | tar -xz -C /tmp/gha-tools
          echo "/tmp/gha-tools" >> "${GITHUB_PATH}"
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Get PR Info
        id: get-pr-info
        uses: rapidsai/shared-action-workflows/get-pr-info@branch-23.06
      - name: Print environment
        run: |
          rapids-print-env
          rapids-logger "nvidia-smi"
          nvidia-smi
      - name: Test notebooks
        # Temporarily just cudf notebooks to speed up iterating on this workflow
        run: /home/rapids/test_notebooks.py -i /home/rapids/notebooks/cudf -o /home/rapids/notebooks_output
      - name: Install awscli
        run: rapids-mamba-retry install -n base awscli
      - name: Upload notebook test outputs
        run: rapids-upload-to-s3 notebooks_output.tar.gz /home/rapids/notebooks_output
